using System.Data;
using System.IO;
using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Configuration;

namespace Thiskord_Back.Services
{
    // La classe implémente l'interface ILogService
    public class LogService
    {
        private readonly string _logFilePath;
        private readonly string _connectionString;

        public LogService(IConfiguration config)
        {
            // Récupération de la chaîne de connexion via l'injection de IConfiguration
            _connectionString = config.GetConnectionString("DefaultConnection")
                                ?? throw new InvalidOperationException("La chaîne de connexion 'Default' est introuvable.");
            string dossierDocuments = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            _logFilePath = Path.Combine(dossierDocuments, "logs.txt");
        }

        // Implémentation de la méthode synchrone de l'interface
        public void AddLog(int userId, string message)
        {
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    // Opération synchrone
                    conn.Open();

                    string query = @"
                        INSERT INTO logs (user_id, message, created_at)
                        VALUES (@user_id, @message, GETDATE());";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.Add("@user_id", SqlDbType.Int).Value = userId;
                        // Gestion si le message est null
                        cmd.Parameters.Add("@message", SqlDbType.NVarChar).Value = (object)message ?? DBNull.Value;

                        // Opération synchrone
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception ex)
            {
                // si il y'a une erreure lors de l'écriture du log  
                Console.WriteLine($"Erreur lors de l'écriture du log : {ex.Message}");
            }
        }

        public void CreateLog(string message)
        {
            try
            {
                using (StreamWriter sw = new StreamWriter(_logFilePath, append: true))
                {
                    sw.WriteLine($"{DateTime.Now}: {message}");
                }
            }
            catch (Exception e)
            {
                Console.WriteLine("Log error pour les logs " + e.Message);
            }
        }

    }
}